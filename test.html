<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CareMatch</title>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root { --p: #C7B9FF; --y: #FFF3C4; --d: #6B5B95; --l: #FAF5FF; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--p), var(--y)); margin:0; padding:20px; display:flex; justify-content:center; }
    #app { background:white; width:90%; max-width:500px; border-radius:24px; box-shadow:0 20px 50px rgba(0,0,0,0.15); overflow:hidden; }
    .progress { height:8px; background:#eee; }
    .fill { height:100%; background:var(--p); width:0%; transition:0.4s; }
    .c { padding:40px 30px; text-align:center; }
    h1 { color:var(--d); margin:0 0 10px; font-size:28px; }
    .home-btn { float:right; background:#ddd; font-size:13px; padding:8px 16px; }
    .q { font-size:18px; margin:30px 0 20px; color:#333; }
    .opts { display:grid; gap:12px; margin:25px 0; }
    .opt { padding:16px; background:var(--l); border-radius:16px; cursor:pointer; transition:0.3s; border:2px solid transparent; }
    .opt:hover { background:var(--p); color:white; }
    .opt.sel { background:var(--d); color:white; border-color:var(--d); }
    .btns { display:flex; justify-content:space-between; margin-top:40px; }
    button { padding:14px 24px; border:none; border-radius:12px; background:var(--p); color:white; cursor:pointer; font-size:16px; }
    button:hover { background:var(--d); }
    .skip { background:#ccc; }
    .result { display:none; text-align:center; }
    .cards { display:grid; gap:20px; margin:30px 0; }
    .card { background:var(--l); border-radius:16px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .card img { width:100%; border-radius:12px; margin-bottom:15px; }
    .buy { background:#FF6B6B; margin-top:15px; display:block; }
    .email-section { margin:40px 0; }
    input[type="email"] { width:100%; padding:16px; border:2px solid #ddd; border-radius:12px; font-size:16px; box-sizing:border-box; }
    .final-btns { display:flex; justify-content:center; gap:15px; margin-top:20px; }
    .restart { background:var(--d); margin-top:40px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="progress"><div class="fill" id="bar"></div></div>
    <div class="c">
      <h1>CareMatch</h1>
      <button class="home-btn" onclick="location.reload()">Заново</button>

      <div id="quiz">
        <div class="q" id="question"></div>
        <div class="opts" id="options"></div>
        <div class="btns">
          <button onclick="prev()">Назад</button>
          <button class="skip" onclick="skip()">Пропустить</button>
          <button onclick="next()">Далее</button>
        </div>
      </div>

      <div id="result" class="result">
        <h2>Ваши идеальные средства</h2>
        <div class="cards" id="cards"></div>

        <div class="email-section">
          <input type="email" id="email" placeholder="your@mail.ru — получите PDF" />
          <div class="final-btns">
            <button onclick="downloadPDF()">Скачать PDF</button>
            <button onclick="sendPDF()">Отправить на почту</button>
          </div>
          <div>
            <button class="restart" onclick="location.reload()">Пройти заново</button>
            <button class="home" onclick="window.location.href = window.location.href">Вернуться на главную</button>
          </div>
        </div>

        
      </div>
    </div>
  </div>

  <script>
    const questions = [
      {q: "Какой у вас тип кожи?", opts: ["Сухая","Жирная","Комбинированная","Нормальная","Чувствительная"]},
      {q: "Что беспокоит кожу больше всего?", opts: ["Сухость","Жирный блеск","Прыщи","Покраснения","Морщинки","Ничего"]},
      {q: "Как кожа реагирует на солнце?", opts: ["Сразу краснеет","Загорает постепенно","Быстро сгорает","Редко горит","Всегда ровно"]},
      {q: "Что важнее в уходе?", opts: ["Увлажнение","Очищение","Питание","Защита","Антивозраст"]},
      {q: "Тип волос?", opts: ["Тонкие","Густые","Вьющиеся","Прямые","Окрашенные"]},
      {q: "Главная проблема волос?", opts: ["Сухость","Жирность","Перхоть","Выпадение","Тусклость","Нет"]},
      {q: "Как часто моете голову?", opts: ["Ежедневно","Через день","2-3 раза в неделю","Раз в неделю"]},
      {q: "Вы беременны или кормите?", opts: ["Да","Нет"]},
      {q: "Важна ли экологичность?", opts: ["Очень","Желательна","Не важно"]},
      {q: "Бюджет в месяц?", opts: ["до 3000₽","3000-7000₽","7000-15000₽","больше 15000₽"]}
    ];

    let current = 0, answers = [];

    function render() {
      const isResult = current === questions.length;
      document.getElementById('quiz').style.display = isResult ? 'none' : 'block';
      document.getElementById('result').style.display = isResult ? 'block' : 'none';
      document.getElementById('bar').style.width = (current / questions.length * 100) + '%';

      if (!isResult) {
        document.getElementById('question').innerText = questions[current].q;
        const opts = document.getElementById('options');
        opts.innerHTML = '';
        questions[current].opts.forEach(o => {
          const div = document.createElement('div');
          div.className = 'opt' + (answers[current] === o ? ' sel' : '');
          div.innerText = o;
          div.onclick = () => { answers[current] = o; render(); };
          opts.appendChild(div);
        });
      } else {
        google.script.run.withSuccessHandler(showCards).getRecommendations(answers);
      }
    }

    function showCards(cards) {
      const container = document.getElementById('cards');
      container.innerHTML = '';
      cards.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<img src="${c.img}" alt="">
          <h3>${c.name}</h3>
          <p>${c.desc}</p>
          <button class="buy" onclick="window.open('${c.link}', '_blank')">Купить →</button>`;
        container.appendChild(card);
      });
    }

    function next() { if (current < questions.length) current++; render(); }
    function prev() { if (current > 0) current--; render(); }
    function skip() { answers[current] = "Пропущено"; next(); }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica");
      doc.setFontSize(20);
      doc.text("CareMatch — Ваш уход", 20, 20);
      doc.setFontSize(12);
      let y = 40;
      questions.forEach((q, i) => {
        doc.text(`${i+1}. ${q.q}`, 20, y);
        doc.text(`   ${answers[i] || 'Пропущено'}`, 25, y + 7);
        y += 15;
      });
      doc.save("CareMatch.pdf");
    }

    function sendPDF() {
      const email = document.getElementById('email').value.trim();
      if (!email || !email.includes('@')) return alert("Введите email!");
      google.script.run
        .withSuccessHandler(() => alert("PDF отправлен на " + email))
        .withFailureHandler(() => alert("Ошибка отправки"))
        .saveAndSend(answers, email);
    }

    render();
  </script>
</body>
</html>